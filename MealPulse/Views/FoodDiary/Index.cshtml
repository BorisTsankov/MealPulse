@using Web.ViewModels
@model FoodDiaryViewModel

@section Styles {
    <link rel="stylesheet" href="~/css/FoodDiary.css" asp-append-version="true" />
}

<div class="food-diary-page">
    @{
        ViewData["Title"] = "Your Food Diary";
        var selectedDate = (DateTime)ViewBag.SelectedDate;
    }

    <h2 class="text-center mt-4 mb-3">Your Food Diary</h2>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }


    <div class="d-flex justify-content-between align-items-center mb-4">
        <a class="btn btn-outline-secondary"
        asp-action="Index"
        asp-route-date="@selectedDate.AddDays(-1).ToString("yyyy-MM-dd")">
            ← Previous
        </a>

        <h4 class="mb-0">Diary for @selectedDate.ToString("D")</h4>

        <a class="btn btn-outline-secondary"
        asp-action="Index"
        asp-route-date="@selectedDate.AddDays(1).ToString("yyyy-MM-dd")">
            Next →
        </a>
    </div>

    @if (ViewBag.TotalCaloriesForDay != null && ViewBag.CalorieGoal != null && ViewBag.RemainingCalories != null)
    {
        <div class="text-center mb-4 summary-section">
            <h5 class="mb-2">Daily Summary</h5>
            <div class="d-flex justify-content-center gap-4">
                <span class="badge badge-consumed fs-6">
                    Total Consumed: @ViewBag.TotalCaloriesForDay.ToString("N0") kcal
                </span>
                <span class="badge badge-goal fs-6">
                    Goal: @ViewBag.CalorieGoal.ToString("N0") kcal
                </span>
                <span class="badge @(ViewBag.RemainingCalories >= 0 ? "badge-remaining" : "badge-exceeded") fs-6">
                    Remaining: @ViewBag.RemainingCalories.ToString("N0") kcal
                </span>
            </div>

            @if ((int)ViewBag.RemainingCalories < 0)
            {
                <p class="badge-exceeded-msg text-center mt-2">
                    🔺 You have exceeded your daily calorie goal.
                </p>
            }
        </div>
    }


    <div class="meal-grid">
        @foreach (var meal in Model.Sections)
        {
            <div class="card shadow-sm">
                <div class="custom-card-header d-flex justify-content-between align-items-center">
                    <strong>@meal.MealName</strong>
                    <span class="badge badge-meal-total">@meal.TotalCalories.ToString("N0") kcal</span>
                </div>

                <div class="card-body">
                    @if (meal.Items != null && meal.Items.Any())
                    {
                        <div class="food-item-scroll mb-3">
                            <ul class="list-group">
                                @foreach (var item in meal.Items)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <form asp-action="DeleteItem"
                                              method="post"
                                              class="d-flex justify-content-between align-items-center w-100"
                                              style="margin: 0;">
                                            <input type="hidden" name="id" value="@item.FoodDiaryItemId" />
                                            <input type="hidden" name="date" value="@selectedDate.ToString("yyyy-MM-dd")" />

                                            <span>@item.FoodName (@item.Quantity @item.Unit)</span>

                                            <div class="d-flex align-items-center gap-3">
                                                <span class="badge badge-item-calories">@item.Calories.ToString("N0") kcal</span>
                                                <button type="submit"
                                                        class="btn p-0 border-0 bg-transparent"
                                                        style="width: 28px; height: 28px; cursor: pointer;"
                                                        title="Delete">
                                                    <img src="~/images/bin_image.png"
                                                         alt="Delete"
                                                         style="width: 100%; height: 100%; object-fit: contain;" />
                                                </button>
                                            </div>
                                        </form>
                                    </li>
                                }
                            </ul>
                        </div>
                    }

                    else
                    {
                        <p class="text-muted fst-italic">No food added yet for @meal.MealName.</p>
                    }

                    <form asp-action="AddItem"
                          asp-route-date="@selectedDate.ToString("yyyy-MM-dd")"
                          method="post"
                          novalidate>
                        <input type="hidden" name="MealTypeId" value="@meal.MealTypeId" />
                        <input type="hidden" name="date" value="@selectedDate.ToString("yyyy-MM-dd")" />

                        <select name="FoodItemId" class="form-select food-search" required></select>
                        <input type="number" name="Quantity" class="form-control" placeholder="Amount (g/ml)" min="1" required />
                        <button type="submit" class="btn">Add</button>
                    </form>
                </div>
            </div>
        }
    </div>


@section Scripts {
    <script>
        $(document).ready(function () {
            $('.food-search').select2({
                placeholder: "Search for food...",
                width: '100%',
                ajax: {
                    url: '@Url.Action("SearchFoodItems", "FoodDiary")',
                    dataType: 'json',
                    minimumInputLength: 2,
                    delay: 4000,
                    data: function (params) {
                        return { term: params.term };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results
                        };
                    },
                    cache: true
                }
            });

            $('form').filter(function () {
                return $(this).attr('action')?.toLowerCase().includes('additem');
            }).each(function () {
                const form = $(this);
                const select = form.find('select[name="FoodItemId"]');
                const input = form.find('input[name="Quantity"]');
                const button = form.find('button[type="submit"]');

                function toggleButton() {
                    const hasFood = select.val();
                    const hasQuantity = input.val() > 0;
                    button.prop('disabled', !(hasFood && hasQuantity));
                }

                select.on('change', toggleButton);
                input.on('input', toggleButton);
                toggleButton();
            });
        });
    </script>
}


