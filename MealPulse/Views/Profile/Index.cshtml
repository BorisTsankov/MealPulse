@using Web.ViewModels
@model UserProfileViewModel

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" />
}

@{
    ViewData["Title"] = "Your Profile";
}

<div class="profile-page">
    <div class="container mt-5">
        <h1 class="text-center mb-4" style="color: #6f42c1;">Profile</h1>

        <div class="row">
            <!-- User Info -->
            <div class="col-md-6 mb-4">
                <div class="profile-card h-100">
                    <h4 class="section-header">User Information</h4>
                    <dl class="row">
                        <dt class="col-sm-4">First Name</dt>
                        <dd class="col-sm-8">@Model.User.FirstName</dd>

                        <dt class="col-sm-4">Last Name</dt>
                        <dd class="col-sm-8">@Model.User.LastName</dd>

                        <dt class="col-sm-4">Email</dt>
                        <dd class="col-sm-8">@Model.User.Email</dd>

                        <dt class="col-sm-4">Birthday</dt>
                        <dd class="col-sm-8">@Model.User.DateOfBirth?.ToString("dd MMM yyyy")</dd>

                        <dt class="col-sm-4">Gender</dt>
                        <dd class="col-sm-8">@Model.GenderName</dd>

                        <dt class="col-sm-4">Height (cm)</dt>
                        <dd class="col-sm-8 d-flex align-items-center">
                            @Model.User.HeightCm
                            <img src="~/images/edit_image.png" alt="Edit Height" id="editHeightBtn" class="ms-2 edit-icon" />
                        </dd>

                        <dt class="col-sm-4">Weight (kg)</dt>
                        <dd class="col-sm-8 d-flex align-items-center">
                            @(Model.Goal?.CurrentWeightKg.ToString() ?? "Not set")
                            <img src="~/images/edit_image.png" alt="Edit Weight" id="editWeightBtn" class="ms-2 edit-icon" />
                        </dd>

                        <dt class="col-sm-4">Activity Level</dt>
                        <dd class="col-sm-8 d-flex align-items-center">
                            @Model.User.ActivityLevelName
                            <img src="~/images/edit_image.png" alt="Edit Activity Level" id="editActivityLevelBtn" class="ms-2 edit-icon" />
                        </dd>

                        <dt class="col-sm-4">Metric</dt>
                        <dd class="col-sm-8">@Model.User.MetricName</dd>
                    </dl>
                </div>
            </div>

            <!-- Goal Info -->
            <div class="col-md-6 mb-4">
                <div class="profile-card h-100">
                    <h4 class="section-header">Current Goal</h4>

                    @if (Model.Goal != null)
                    {
                        <dl class="row">
                            <dt class="col-sm-6">Recommended Daily Calories</dt>
                            <dd class="col-sm-6">@Model.DailyCalories?.ToString("N0")</dd>

                            <dt class="col-sm-6">Current Weight</dt>
                            <dd class="col-sm-6">@Model.Goal.CurrentWeightKg</dd>

                            <dt class="col-sm-6">Target Weight</dt>
                            <dd class="col-sm-6">@Model.Goal.TargetWeightKg</dd>

                            <dt class="col-sm-6">Start Date</dt>
                            <dd class="col-sm-6">@Model.Goal.StartDate.ToShortDateString()</dd>

                            <dt class="col-sm-6">End Date</dt>
                            <dd class="col-sm-6">@Model.Goal.EndDate?.ToShortDateString()</dd>

                            <dt class="col-sm-6">Goal Intensity</dt>
                            <dd class="col-sm-6">@Model.GoalIntensityDisplay</dd>
                        </dl>
                    }
                    else
                    {
                        <p><em>You do not have a current goal.</em></p>
                    }

                    <button id="createGoalBtn" class="btn btn-success mt-3">Create New Goal</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals with styled inputs -->
<div class="modal fade" id="editHeightModal" tabindex="-1" aria-labelledby="editHeightModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UpdateHeight" asp-controller="Profile" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Update Height</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="user_id" value="@Model.User.UserId" />
                    <div class="form-group">
                        <label for="newHeight">New Height (cm)</label>
                        <input type="number" step="0.1" name="newHeight" class="form-control" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Height</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editWeightModal" tabindex="-1" aria-labelledby="editWeightModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UpdateWeight" asp-controller="Profile" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Update Weight</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="user_id" value="@Model.User.UserId" />
                    <div class="form-group">
                        <label for="newWeight">New Weight (kg)</label>
                        <input type="number" step="0.1" name="newWeight" class="form-control" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Weight</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="createGoalModal" tabindex="-1" aria-labelledby="createGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="CreateGoal" asp-controller="Profile" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Goal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="user_id" value="@Model.User.UserId" />

                    <div class="form-group">
                        <label for="currentWeight">Current Weight (kg)</label>
                        <input type="number" step="0.1" name="currentWeight" class="form-control" value="@Model.Goal?.CurrentWeightKg" required />
                    </div>

                    <div class="form-group">
                        <label for="targetWeight">Target Weight (kg)</label>
                        <input type="number" step="0.1" name="targetWeight" class="form-control" required />
                    </div>

                    <div class="form-group">
                        <label for="intensity">Goal Intensity</label>
                        <select name="intensity" class="form-control" asp-items="ViewBag.IntensityOptions" required>
                            <option value="">-- Select Intensity --</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Goal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editActivityLevelModal" tabindex="-1" aria-labelledby="editActivityLevelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UpdateActivityLevel" asp-controller="Profile" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Update Activity Level</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="user_id" value="@Model.User.UserId" />
                    <div class="form-group">
                        <label for="newActivityLevelId">New Activity Level</label>
                        <select name="newActivityLevelId" class="form-control" asp-items="ViewBag.ActivityLevelOptions" required>
                            <option value="">-- Select Activity Level --</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Activity Level</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Dynamic input styling -->
<style>
    input.form-control-purple, select.form-control-purple {
        border: 1px solid #c2abd6;
        background-color: #fefaff;
        color: #2d1b46;
        border-radius: 8px;
    }

        input.form-control-purple:focus, select.form-control-purple:focus {
            border-color: #6f42c1;
            box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
            outline: none;
        }
</style>

@section Scripts {
    <script>
        document.getElementById("editHeightBtn")?.addEventListener("click", () => {
            new bootstrap.Modal(document.getElementById('editHeightModal')).show();
        });

        document.getElementById("editWeightBtn")?.addEventListener("click", () => {
            new bootstrap.Modal(document.getElementById('editWeightModal')).show();
        });

        document.getElementById("createGoalBtn")?.addEventListener("click", () => {
            new bootstrap.Modal(document.getElementById('createGoalModal')).show();
        });

                document.getElementById("editActivityLevelBtn")?.addEventListener("click", () => {
            new bootstrap.Modal(document.getElementById('editActivityLevelModal')).show();
        });


        const currentWeightInput = document.querySelector("input[name='currentWeight']");
        const targetWeightInput = document.querySelector("input[name='targetWeight']");
        const intensitySelect = document.querySelector("select[name='intensity']");

        const intensityOptions = {
            lose: [
                { value: "1", text: "Lose 0.25 kg/week" },
                { value: "2", text: "Lose 0.5 kg/week" },
                { value: "3", text: "Lose 1 kg/week" }
            ],
            gain: [
                { value: "4", text: "Gain 0.25 kg/week" },
                { value: "5", text: "Gain 0.5 kg/week" },
                { value: "6", text: "Gain 1 kg/week" }
            ],
            maintain: [
                { value: "0", text: "Maintain Weight" }
            ]
        };

        function updateIntensityOptions() {
            const current = parseFloat(currentWeightInput?.value);
            const target = parseFloat(targetWeightInput?.value);
            if (isNaN(current) || isNaN(target)) return;

            intensitySelect.innerHTML = '<option value="">-- Select Intensity --</option>';
            let options = [];

            if (current > target) options = intensityOptions.lose;
            else if (current < target) options = intensityOptions.gain;
            else options = intensityOptions.maintain;

            options.forEach(opt => {
                const option = document.createElement("option");
                option.value = opt.value;
                option.text = opt.text;
                intensitySelect.appendChild(option);
            });
        }

        currentWeightInput?.addEventListener("input", updateIntensityOptions);
        targetWeightInput?.addEventListener("input", updateIntensityOptions);

        // Apply purple class styling to modal fields
        document.querySelectorAll('#editHeightModal input, #editWeightModal input, #createGoalModal input, #createGoalModal select')
            .forEach(el => el.classList.add('form-control-purple'));
    </script>
}
