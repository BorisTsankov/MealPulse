@model MealPulse.ViewModels.UserProfileViewModel

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" />
}

@{
    ViewData["Title"] = "Your Profile";
}

<div class="profile-page">
    <div class="container mt-5">
        <h1 class="text-center mb-4" style="color: #6f42c1;">Your Profile</h1>

        <div class="profile-card">
            <h4 class="section-header">User Information</h4>
            <dl class="row">
                <dt class="col-sm-3">First Name</dt>
                <dd class="col-sm-9">@Model.User.FirstName</dd>

                <dt class="col-sm-3">Last Name</dt>
                <dd class="col-sm-9">@Model.User.LastName</dd>

                <dt class="col-sm-3">Email</dt>
                <dd class="col-sm-9">@Model.User.email</dd>

                <dt class="col-sm-3">Birthday</dt>
                <dd class="col-sm-9">
                    @(Model.User.date_of_birth?.ToString("dd MMM yyyy"))
                </dd>

                <dt class="col-sm-3">Gender</dt>
                <dd class="col-sm-9">@Model.GenderName</dd>

                <dt class="col-sm-3">Height (cm)</dt>
                <dd class="col-sm-9 d-flex align-items-center">
                    @Model.User.height_cm
                    <img src="~/images/edit_image.png" alt="Edit Height" id="editHeightBtn" class="ms-2" style="cursor:pointer; width: 20px; height: 20px;" />
                </dd>

                <dt class="col-sm-3">Weight (kg)</dt>
                <dd class="col-sm-9 d-flex align-items-center">
                    @(Model.Goal?.current_weight_kg.ToString() ?? "Not set")
                    <img src="~/images/edit_image.png" alt="Edit Weight" id="editWeightBtn" class="ms-2" style="cursor:pointer; width: 20px; height: 20px;" />
                </dd>

                <dt class="col-sm-3">Activity Level</dt>
                <dd class="col-sm-9 d-flex align-items-center">
                    @Model.ActivityLevelName
                    <img src="~/images/edit_image.png" alt="Edit Activity Level" id="editActivityLevelBtn" class="ms-2" style="cursor:pointer; width: 20px; height: 20px;" />
                </dd>


                <dt class="col-sm-3">Metric</dt>
                <dd class="col-sm-9">@Model.MetricName</dd>
            </dl>
        </div>

        <div class="profile-card">
            <h4 class="section-header">Current Goal</h4>

            @if (Model.Goal != null)
            {
                <dt class="col-sm-3">Recommended Daily Calories</dt>
                <dd class="col-sm-9">
                    @(Model.DailyCalories?.ToString("N0") ?? "Unavailable")
                </dd>

                <dl class="row">
                    <dt class="col-sm-3">Current Weight</dt>
                    <dd class="col-sm-9">@Model.Goal.current_weight_kg</dd>

                    <dt class="col-sm-3">Target Weight</dt>
                    <dd class="col-sm-9">@Model.Goal.target_weight_kg</dd>

                    <dt class="col-sm-3">Start Date</dt>
                    <dd class="col-sm-9">@Model.Goal.start_date.ToShortDateString()</dd>

                    <dt class="col-sm-3">End Date</dt>
                    <dd class="col-sm-9">@Model.Goal.end_date?.ToShortDateString()</dd>

                    <dt class="col-sm-3">Goal Intensity</dt>
                    <dd class="col-sm-9">@Model.GoalIntensityDisplay</dd>
                </dl>
            }
            else
            {
                <p><em>You do not have a current goal.</em></p>
            }

            <button id="createGoalBtn" class="btn btn-success mt-3">Create New Goal</button>
        </div>
    </div>
</div>

<!-- Modals with styled inputs -->
<div class="modal fade" id="editHeightModal" tabindex="-1" aria-labelledby="editHeightModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UpdateHeight" asp-controller="Profile" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Update Height</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="user_id" value="@Model.User.user_id" />
                    <div class="form-group">
                        <label for="newHeight">New Height (cm)</label>
                        <input type="number" step="0.1" name="newHeight" class="form-control" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Height</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editWeightModal" tabindex="-1" aria-labelledby="editWeightModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UpdateWeight" asp-controller="Profile" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Update Weight</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="user_id" value="@Model.User.user_id" />
                    <div class="form-group">
                        <label for="newWeight">New Weight (kg)</label>
                        <input type="number" step="0.1" name="newWeight" class="form-control" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Weight</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="createGoalModal" tabindex="-1" aria-labelledby="createGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="CreateGoal" asp-controller="Profile" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Goal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="user_id" value="@Model.User.user_id" />

                    <div class="form-group">
                        <label for="currentWeight">Current Weight (kg)</label>
                        <input type="number" step="0.1" name="currentWeight" class="form-control" value="@Model.Goal?.current_weight_kg" required />
                    </div>

                    <div class="form-group">
                        <label for="targetWeight">Target Weight (kg)</label>
                        <input type="number" step="0.1" name="targetWeight" class="form-control" required />
                    </div>

                    <div class="form-group">
                        <label for="intensity">Goal Intensity</label>
                        <select name="intensity" class="form-control" asp-items="ViewBag.IntensityOptions" required>
                            <option value="">-- Select Intensity --</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Goal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editActivityLevelModal" tabindex="-1" aria-labelledby="editActivityLevelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UpdateActivityLevel" asp-controller="Profile" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Update Activity Level</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="user_id" value="@Model.User.user_id" />
                    <div class="form-group">
                        <label for="newActivityLevelId">New Activity Level</label>
                        <select name="newActivityLevelId" class="form-control" asp-items="ViewBag.ActivityLevelOptions" required>
                            <option value="">-- Select Activity Level --</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Activity Level</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Dynamic input styling -->
<style>
    input.form-control-purple, select.form-control-purple {
        border: 1px solid #c2abd6;
        background-color: #fefaff;
        color: #2d1b46;
        border-radius: 8px;
    }

        input.form-control-purple:focus, select.form-control-purple:focus {
            border-color: #6f42c1;
            box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
            outline: none;
        }
</style>

@section Scripts {
    <script>
        document.getElementById("editHeightBtn")?.addEventListener("click", () => {
            new bootstrap.Modal(document.getElementById('editHeightModal')).show();
        });

        document.getElementById("editWeightBtn")?.addEventListener("click", () => {
            new bootstrap.Modal(document.getElementById('editWeightModal')).show();
        });

        document.getElementById("createGoalBtn")?.addEventListener("click", () => {
            new bootstrap.Modal(document.getElementById('createGoalModal')).show();
        });

                document.getElementById("editActivityLevelBtn")?.addEventListener("click", () => {
            new bootstrap.Modal(document.getElementById('editActivityLevelModal')).show();
        });


        const currentWeightInput = document.querySelector("input[name='currentWeight']");
        const targetWeightInput = document.querySelector("input[name='targetWeight']");
        const intensitySelect = document.querySelector("select[name='intensity']");

        const intensityOptions = {
            lose: [
                { value: "1", text: "Lose 0.25 kg/week" },
                { value: "2", text: "Lose 0.5 kg/week" },
                { value: "3", text: "Lose 1 kg/week" }
            ],
            gain: [
                { value: "4", text: "Gain 0.25 kg/week" },
                { value: "5", text: "Gain 0.5 kg/week" },
                { value: "6", text: "Gain 1 kg/week" }
            ],
            maintain: [
                { value: "0", text: "Maintain Weight" }
            ]
        };

        function updateIntensityOptions() {
            const current = parseFloat(currentWeightInput?.value);
            const target = parseFloat(targetWeightInput?.value);
            if (isNaN(current) || isNaN(target)) return;

            intensitySelect.innerHTML = '<option value="">-- Select Intensity --</option>';
            let options = [];

            if (current > target) options = intensityOptions.lose;
            else if (current < target) options = intensityOptions.gain;
            else options = intensityOptions.maintain;

            options.forEach(opt => {
                const option = document.createElement("option");
                option.value = opt.value;
                option.text = opt.text;
                intensitySelect.appendChild(option);
            });
        }

        currentWeightInput?.addEventListener("input", updateIntensityOptions);
        targetWeightInput?.addEventListener("input", updateIntensityOptions);

        // Apply purple class styling to modal fields
        document.querySelectorAll('#editHeightModal input, #editWeightModal input, #createGoalModal input, #createGoalModal select')
            .forEach(el => el.classList.add('form-control-purple'));
    </script>
}
